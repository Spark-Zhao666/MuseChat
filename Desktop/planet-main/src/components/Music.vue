<template>
  <div id="music-container" class="music-container">
    <div id="music-switch" class="music-switch">
      <svg width="63" height="65" viewBox="0 0 63 65" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 43.994C0 55.5748 9.46453 65 21.0936 65C29.1546 65 36.1607 60.4717 39.7066 53.8414C39.7392 53.7873 39.761 53.7331 39.7828 53.6789C43.9384 45.7485 42.6112 36.0966 36.3451 29.5425C36.2799 29.445 36.2037 29.3583 36.1058 29.2825C22.9645 15.9683 0 25.1762 0 43.994ZM2.45852 40.9173C5.17813 40.1914 7.4518 39.6714 10.9114 39.7256C14.0553 39.7797 14.0227 41.2748 11.9558 43.4523C9.22523 46.3123 9.12735 47.8507 10.8788 50.6241C11.2813 51.2633 11.6729 51.8808 11.7055 52.455C11.7708 53.3758 10.5525 54.275 9.69303 53.9499C8.60517 53.5383 7.43029 52.7799 5.99432 52.6608C4.30812 52.5091 5.02614 52.9316 4.06883 52.1516C2.40442 48.7174 1.78436 44.9693 2.4588 40.9278L2.45852 40.9173ZM14.9147 61.7826C16.7641 58.9442 14.7842 56.2034 20.7783 55.0334C22.4427 54.7083 22.6386 54.8492 23.5415 56.2467L27.2076 61.8042C25.2821 62.465 23.2369 62.8334 21.0938 62.8334C18.9508 62.8334 16.8511 62.4542 14.9147 61.7826ZM38.5211 51.3069C35.4968 48.0352 32.1571 49.0644 28.817 48.3928C26.2932 47.8944 24.161 46.1178 23.4974 43.9728C22.8012 41.7302 23.9326 39.0652 25.9234 38.2744C27.8924 37.4835 29.6547 37.9819 31.2321 34.6343C31.8631 33.3018 32.7551 32.1318 35.0722 31.3735C38.1182 34.721 40.0002 39.141 40.0002 44.0054C40.0002 46.5946 39.4675 49.0646 38.5211 51.3069ZM20.3864 27.1705C20.3646 28.1346 19.5378 31.0921 18.7111 31.6013C18.276 31.8722 17.5689 31.8613 16.84 31.8072C13.5112 31.5905 12.5973 30.6263 14.0225 26.6722C14.0442 26.618 14.0333 26.5747 14.0442 26.5205C15.7631 25.8272 17.6015 25.383 19.527 25.2313C20.1689 25.6972 20.3973 26.3796 20.3756 27.1596L20.3864 27.1705ZM11.3786 27.8638C10.5627 31.4172 12.2272 34.0064 17.5576 34.0064C20.0488 34.0064 21.0279 32.7605 21.8112 30.5072C22.4421 28.698 22.9425 26.9972 22.2028 25.2205C26.4563 25.4697 30.3403 27.1055 33.3856 29.6947C29.3496 31.5039 29.5672 34.0388 28.4685 35.0355C27.7614 35.6855 26.3907 35.7505 25.1397 36.2488C22.1154 37.4514 20.4184 41.2755 21.4518 44.5904C22.3548 47.5262 25.0962 49.8446 28.4253 50.4946C31.134 51.0362 33.9624 50.5596 35.8986 51.8162C36.486 52.2062 36.9864 52.7587 37.4977 53.3654C35.594 56.6479 32.7329 59.2913 29.2843 60.9491C24.5631 53.7446 24.5086 53.5283 23.3881 53.0083C22.3221 52.51 21.158 52.7375 20.3965 52.8891C12.825 54.3625 14.6635 58.7175 12.8905 60.9055C9.9968 59.4972 7.50555 57.3955 5.66709 54.7955C7.76664 54.8172 9.59424 57.4496 12.3791 55.3913C13.4235 54.6221 13.9892 53.463 13.913 52.2821C13.8369 51.1554 13.2603 50.2454 12.749 49.4437C11.5959 47.6237 11.4544 47.1362 13.5649 44.9262C17.318 40.9612 15.5883 37.6136 10.9758 37.538C8.31053 37.5055 5.62351 37.8414 3.02344 38.5239C4.39418 34.0172 7.42924 30.2253 11.4109 27.8423L11.3786 27.8638ZM61.7897 13.5527C61.7897 6.07779 55.6869 0 48.1805 0C40.6742 0 34.5714 6.07752 34.5714 13.5527C34.5714 21.0278 40.6742 27.1053 48.1805 27.1053C55.6869 27.1053 61.7897 21.0278 61.7897 13.5527ZM38.7599 19.9877C44.3514 20.1177 46.277 20.4535 46.7449 20.4535C48.1156 20.4535 48.2135 18.4276 46.8537 18.2868C43.786 17.9835 40.6747 17.821 37.5744 17.7885C36.6279 15.4377 36.4757 12.8593 37.2154 10.3566C40.4681 8.55823 44.6344 11.5374 48.8013 10.8658C50.2264 10.6383 49.8674 8.49325 48.4532 8.73162C45.4181 9.21912 42.0675 7.14998 38.3906 7.72413C41.5563 2.49158 48.1921 0.692997 53.5224 3.49907C52.6957 3.56407 51.858 3.57491 51.0203 3.49907C49.5844 3.36907 49.3885 5.52493 50.8136 5.65493C52.5107 5.8066 54.2186 5.71993 56.0245 5.30826C57.8629 7.04161 59.1249 9.35999 59.4948 11.9708C58.8529 14.1591 53.0003 14.3867 50.7808 14.1808C49.3666 14.0183 49.1272 16.2067 50.5741 16.3367C53.2611 16.5967 57.3514 16.2392 59.5164 15.0151C58.7985 20.6159 54.001 24.9603 48.1811 24.9603C44.2757 24.9603 40.8164 22.9995 38.7605 20.0094L38.7599 19.9877ZM22.9861 4.77723L22.2029 2.0364C21.4631 -0.552798 17.7644 -0.552798 17.0247 2.0364L16.2414 4.77723C16.1326 5.1564 16.0347 5.0914 13.141 5.91472C10.541 6.65139 10.541 10.3347 13.141 11.0714C16.1109 11.9165 16.1435 11.8406 16.2414 12.2089L17.0247 14.9497C17.7644 17.5389 21.4631 17.5389 22.2029 14.9497C23.0514 12.0031 22.9753 11.9597 23.3451 11.8622L26.0974 11.0822C28.6973 10.3456 28.6973 6.66221 26.0974 5.92554C23.1384 5.0805 23.0949 5.15635 22.997 4.78805L22.9861 4.77723ZM22.7468 9.76059C21.8439 10.0206 21.1586 10.7031 20.8975 11.6022L20.1142 14.3431C19.9728 14.8414 19.2656 14.8414 19.1242 14.3431C18.4389 11.9489 18.3083 10.2805 16.4917 9.76052C13.511 8.91548 13.3695 8.99133 13.3695 8.48215C13.3695 8.34132 13.413 8.08132 13.7394 7.98381C18.3954 6.66217 17.8297 7.14966 19.1243 2.62126C19.2657 2.12293 19.9728 2.12293 20.1142 2.62126C20.7996 5.00461 20.9302 6.6838 22.7468 7.20381C25.7275 8.04885 25.869 7.973 25.869 8.48218C25.869 8.62301 25.7167 8.91552 22.736 9.76056L22.7468 9.76059ZM48.0937 42.6289L50.8459 43.4089C51.2158 43.5173 51.1397 43.5389 51.9882 46.4964C52.7279 49.0856 56.4266 49.0856 57.1664 46.4964L57.9496 43.7556C58.0584 43.3764 58.1563 43.4414 61.05 42.6181C63.65 41.8814 63.65 38.1981 61.05 37.4614L58.2977 36.6814C57.917 36.5731 57.9823 36.4756 57.1555 33.5939C56.4158 31.0047 52.7171 31.0047 51.9773 33.5939C51.1287 36.5514 51.2049 36.5839 50.8351 36.6814L48.0828 37.4614C45.4828 38.1981 45.4828 41.8814 48.0828 42.6181L48.0937 42.6289ZM51.4443 38.7831C52.3472 38.5231 53.0325 37.8405 53.2936 36.9414C54.1422 33.9731 54.066 33.8322 54.5773 33.8322C55.0886 33.8322 55.0125 34.0056 55.861 36.9414C56.1221 37.8406 56.8075 38.5231 57.7103 38.7831L60.4626 39.5631C60.963 39.7039 60.963 40.4081 60.4626 40.5489C58.0693 41.2314 56.3831 41.3614 55.8609 43.1706C55.0124 46.1389 55.0885 46.2798 54.5772 46.2798C54.0659 46.2798 54.1421 46.1064 53.2935 43.1706C52.7714 41.3397 51.1287 41.2423 48.6919 40.5489C48.3655 40.4622 48.322 40.2022 48.322 40.0506C48.322 39.5306 48.4961 39.6172 51.4442 38.7722L51.4443 38.7831Z" fill="white"/>
      </svg>
      <div class="music-title">
        <p class="text-style">Listen to Another Planet</p>
      </div>
    </div>
    <br/>
    <div class="music-player">
      <svg id="music-player" width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"
        :class="{ rotating: isPlaying }">
        <g v-if="!isPlaying" opacity="0.9">
          <path d="M32 64C49.645 64 64 49.645 64 32C64 14.355 49.645 0 32 0C14.355 0 0 14.356 0 32C0 49.644 14.355 64 32 64ZM32 2C48.542 2 62 15.458 62 32C62 48.542 48.542 62 32 62C15.458 62 2 48.542 2 32C2 15.458 15.458 2 32 2Z" fill="white"/>
          <path d="M22.2438 50.2051C26.7838 50.2051 30.4778 47.0841 30.4778 43.2481V29.8621L42.3088 27.9981V34.1901C41.7028 34.0721 41.0788 34.0111 40.4458 34.0111C35.9058 34.0111 32.2118 37.1321 32.2118 40.9681C32.2118 44.8041 35.9058 47.9251 40.4458 47.9251C44.3988 47.9251 47.7098 45.5601 48.5008 42.4161H48.6388L48.6578 41.4761C48.6718 41.3081 48.6798 41.1381 48.6798 40.9671C48.6798 40.8841 48.6778 40.8021 48.6738 40.7221L48.6798 40.4151V15.8781V13.4331L46.2838 13.9171L25.9048 18.0361L24.3008 18.3601V19.9961V36.5051C23.6378 36.3631 22.9488 36.2901 22.2428 36.2901C17.7028 36.2901 14.0088 39.4111 14.0088 43.2471C14.0098 47.0841 17.7038 50.2051 22.2438 50.2051ZM22.2438 38.2911C23.7978 38.2911 25.2078 38.7401 26.3018 39.4861V19.9971L46.6808 15.8781V40.4161H46.6398C46.6608 40.5901 46.6808 40.7841 46.6808 40.9681C46.6808 43.7071 43.8908 45.9251 40.4468 45.9251C37.0028 45.9251 34.2128 43.7071 34.2128 40.9681C34.2128 38.2291 37.0028 36.0111 40.4468 36.0111C41.9088 36.0111 43.2478 36.4201 44.3098 37.0841V25.6581L28.4788 28.1521V43.2481C28.4788 45.9871 25.6888 48.2051 22.2448 48.2051C18.8008 48.2051 16.0108 45.9871 16.0108 43.2481C16.0108 40.5091 18.7998 38.2911 22.2438 38.2911Z" fill="white"/>
        </g>
        <g v-else>
            <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M32 0C40.4858 0 48.6259 3.37135 54.6272 9.37278C60.6287 15.3742 64 23.5142 64 32C64 40.4858 60.6287 48.6259 54.6272 54.6272C48.6258 60.6287 40.4858 64 32 64C23.5142 64 15.3741 60.6287 9.37278 54.6272C3.37135 48.6258 0 40.4858 0 32C0 23.5142 3.36861 15.3713 9.36997 9.36997C15.3714 3.36854 23.5142 0 32 0ZM47.2645 41.0959V16.7636C47.27 16.1816 47.0119 15.6298 46.5617 15.2592C46.1362 14.8776 45.5624 14.6991 44.9941 14.7732L24.5083 17.2825C23.5035 17.3978 22.7458 18.2516 22.7513 19.2647V39.2261C22.7375 39.4155 22.6497 39.5912 22.5069 39.7148C22.3614 39.8356 22.1747 39.896 21.9853 39.8795C21.4747 39.7999 20.9558 39.7752 20.4397 39.8081C19.9071 39.8383 19.38 39.9234 18.8638 40.0607C17.3428 40.4396 15.9894 41.3125 15.012 42.5425C14.1472 43.5198 13.8425 44.8706 14.2022 46.128C14.5618 47.3826 15.5391 48.3655 16.7911 48.7333C18.2131 49.2989 19.7808 49.3922 21.2606 49.0024C22.5811 48.6757 23.7918 48.0085 24.7746 47.0696C25.5434 46.3311 25.9909 45.3208 26.0183 44.2584V23.6159C26.0348 23.2837 26.2818 23.0092 26.6085 22.9542L43.2731 20.9227C43.6492 20.9227 43.9567 21.2164 43.9759 21.5925V36.0636C43.9649 36.2557 43.877 36.4342 43.7315 36.5577C43.586 36.684 43.3938 36.7417 43.2044 36.7225C42.1612 36.5605 41.0987 36.6236 40.0829 36.9064C38.551 37.2798 37.1893 38.1555 36.2174 39.3937C35.3471 40.3683 35.0369 41.7191 35.3965 42.9765C35.7562 44.2312 36.7335 45.214 37.9882 45.5791C39.4103 46.1474 40.9779 46.2407 42.4577 45.8454C43.7809 45.5242 44.9944 44.8571 45.9718 43.9127C46.7624 43.1851 47.2289 42.1693 47.2645 41.0959Z" fill="white"/>
            </svg>
        </g>
      </svg>
      <div v-if="isPlaying" class="music-title">
        <p class="text-style">A sound is forming...</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import emitter from "@/utils/emitter.ts";
import { ref, onUnmounted } from 'vue';
import * as Tone from 'tone';

const isPlaying = ref(false);
let player: Tone.Player | null = null;
let analyser: Tone.Analyser | null = null;

function startSpectrumLoop() {
  if (!analyser) return;
  const freqData = analyser.getValue();
  // 兼容TypedArray和普通数组
  const arr = Array.isArray(freqData) ? freqData : Array.from(freqData as ArrayLike<number>);
  emitter.emit('action', {
    type:'music_spectrum',
    value: arr,
  }); // 实时发送频谱数据
  requestAnimationFrame(startSpectrumLoop);
}

emitter.on('action', handleMusic);

function handleMusic(event: any) {
  const action_type = event.type;
  if (action_type === 'play_music') {
    const musicUrl = event.value;
    // 如果已经在播放音乐，则不打断当前播放，直接返回
    if (isPlaying.value) {
      return;
    }
    if (player) {
      player.dispose();
      player = null;
    }
    if (analyser) {
      analyser.dispose();
      analyser = null;
    }
    player = new Tone.Player(musicUrl, () => {
      Tone.start();
      player!.start();
      isPlaying.value = true;
      startSpectrumLoop();
    }).toDestination();
    analyser = new Tone.Analyser('fft', 64);
    player.connect(analyser);
    player.onstop = () => {
      emitter.emit('action', {
        type: 'stop_music',
        value: ""
      })
      isPlaying.value = false;
    };
  }
}

onUnmounted(() => {
  if (player) {
    player.dispose();
    player = null;
  }
  if (analyser) {
    analyser.dispose();
    analyser = null;
  }
});
</script>
<style scoped>
.music-container {
  position: fixed;
  right: 2rem;
  top: 2rem;
  width: 30%;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  padding: 1.5rem;
  color: white;
}
.music-player {
  display: flex;
  align-items: center;
}
.music-player svg {
  flex-shrink: 0;
  transition: transform 0.5s linear;
}
.music-player .rotating {
  animation: rotate 5s linear infinite;
}
@keyframes rotate {
  100% {
    transform: rotate(360deg);
  }
}
.music-title {
  margin-left: 1.2rem;
}

.music-switch {
  display: flex;
  align-items: center;
}
.music-switch svg {
  flex-shrink: 0;
}

.text-style {
  font-family: 'sans-serif';
  font-style: italic;
  font-weight: 500;
  font-size: 20px;
  line-height: 30px;
  color: #FFFFFF;
  opacity: 0.9;
}


</style>
